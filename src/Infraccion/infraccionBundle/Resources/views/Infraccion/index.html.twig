{% extends '::layout.html.twig' %}
{% block id 'mod_Infraccion' %}
    {% block title %}
        {{ parent() }} - Infracciones
    {% endblock %}

    {% block page %}

        <section id="Infraccion">
        {% form_theme filterForm with ['LexikFormFilterBundle:Form:form_div_layout.html.twig' ] %}

        {% embed 'box.html.twig' with {'box_titulo': 'Lista de Infracciones' } %}
            {% block rigth_title %}
            <a class="btn dropdown-toggle btn-mini" data-toggle="collapse"
               data-target="#filters">
                {{ 'views.index.filters'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                <span class="caret"></span>
            </a> &nbsp;
            {% endblock %}

            {% block box_contenido %}

            <div class="row-fluid">
                <div class="span12" style="margin-top: 0;">

                    <div class="breadcrumb">
                        <div class="row-fluid">
                            <div class="span3">
                                Municipio
                                <h3> {{ filtro.municipio.nombre }}</h3>
                            </div>
                            <div class="span3">Ubicación
                                <h3> {{ filtro.ubicacion.referencia ~' - '~ filtro.ubicacion.ubicacion }}</h3>
                            </div>
                            <div class="span3">
                                Tipo de Infracción
                                <h3>{{ filtro.tipoInfraccion.nombre }}</h3>
                            </div>
                            <div class="span3">
                                Fecha
                                <h3>{{ filtro.fecha |date('d-m-Y') }}</h3>
                            </div>
                        </div>
                    </div>



                    {% for type, flashMessages in app.session.flashbag.all() %}
                        {% for flashMessage in flashMessages %}
                            <div class='alert alert-{{ type }}'>
                                {{ flashMessage|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                            </div>
                        {% endfor %}
                    {% endfor %}
                </div>
            </div>

            {% if form_errors(filterForm) %}
            <div class="alert alert-block alert-error fade in form-errors">
                {{ form_errors(filterForm) }}
            </div>
            {% endif %}
            &nbsp;

            <div id="filters" class="collapse">
                <form class="well" action="{{ path('infraccion') }}"
                      method="post" {{ form_enctype(filterForm) }}>
                    {{ form_row(filterForm.dominio) }}

                    {{ form_row(filterForm.etapa) }}

                    {{ form_rest(filterForm) }}

                    <p>
                        <button type="submit" name="filter_action"
                                value="reset">{{ 'views.index.reset'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                        <button type="submit" name="filter_action"
                                value="filter">{{ 'views.index.filter'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                    </p>
                </form>
            </div>

            <div class="row-fluid" style="margin-top: 0;">
                <div class="span12" style="zoom: 1; overflow: auto; margin-top: -8px;">
                    <table class="table table-striped table-bordered table-condensed">
                        <thead>
                        <tr>

                            <th>Dominio</th>
                            <th>Hora</th>
                            <th>Datos</th>
                            <th>Foto 1</th>
                            {% if filtro.tipoInfraccion.cantidadFoto >= 2 %}
                                <th>Foto 2</th>
                            {% endif %}
                            {% if filtro.tipoInfraccion.cantidadFoto == 3 %}
                                <th>Foto 3</th>
                            {% endif %}
                            <th>Etapa</th>


                            <th>{{ 'views.index.actions'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for entity in entities %}

                            <tr>
                                <td style="width: 60px;"><span
                                            class="ver_dominio">  {{ entity.automotor.dominio | default("") }} </span>
                                </td>
                                <td style="width: 50px;">{% if entity.fecha %}{{ entity.fecha|date('H:i:s') }}{% endif %}</td>
                                <td style="width: 300px;">
                                    <div class="dominio_edit">
                                        {% include 'InfraccionBundle:Infraccion:_dominio_ver.html.twig' with {entity: entity.automotor} %}
                                    </div>
                                    <a class="btn_dom_edit pull-right"
                                       href="{{ path("infraccion_dominio_edit", {"id": entity.automotor.id}) }}"
                                       class="pull-right">Editar</a>
                                </td>
                                <td>
                                    <img class="fotoinfra" data-id="{{ entity.id }}" data-foto="1"
                                         data-dir="{{ entity.fecha| date('Ym') ~ '/' }}"
                                         src="{{ asset(infraccion.infracciones.dir~ entity.fecha| date('Ym') ~ '/' ~ entity.foto1  ) }}"
                                         style="width: 200px;" alt="No se encuentra la imagen"/>
                                </td>
                                {% if filtro.tipoInfraccion.cantidadFoto >= 2 %}
                                    <td>
                                        <img class="fotoinfra" data-id="{{ entity.id }}" data-foto="2"
                                             data-dir="{{ entity.fecha| date('Ym') ~ '/' }}"
                                             src="{{ asset(infraccion.infracciones.dir ~ entity.fecha| date('Ym') ~ '/' ~ entity.foto2) }}"
                                             style="width: 200px;" alt="No se encuentra la imagen"/></td>
                                {% endif %}
                                {% if filtro.tipoInfraccion.cantidadFoto == 3 %}
                                    <td>
                                        <img class="fotoinfra" data-id="{{ entity.id }}" data-foto="3"
                                             data-dir="{{ entity.fecha| date('Ym') ~ '/' }}"
                                             src="{{ asset(infraccion.infracciones.dir ~ entity.fecha| date('Ym') ~ '/' ~ entity.foto3) }}"
                                             style="width: 200px;" style="width: 200px;" " alt="No se encuentra la
                                        imagen" />
                                    </td>

                                {% endif %}
                                <td>{{ entity.etapa }}</td>

                                <td>
                                    <a class="btn btn-mini"
                                       href="{{ path('infraccion_show', { 'id': entity.id }) }}">
                                        {{ 'views.actions.show'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                                    </a>
                                    <a class="btn btn-mini"
                                       href="{{ path('infraccion_edit', { 'id': entity.id }) }}">
                                        {{ 'views.actions.edit'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                                    </a></td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row-fluid">

                <div class="span10">
                    {{ pagerHtml|raw }}
                </div>

                {#<div class="span2">#}
                {#<a class="btn btn-primary likepaginator" href="{{ path('infraccion_new') }}">#}
                {#{{ 'views.index.createnew'|trans({}, 'JordiLlonchCrudGeneratorBundle') }} Infraccion#}
                {#</a>#}
                {#</div>#}
            </div>


            {#para modal#}
        <div id="myModal_auto_edit"
            </div>
            <script>

                $(function () {
                    $(".fotoinfra").dblclick(function () {
                        $(this).css('width', 200);
                    });


                    $(".fotoinfra").mousewheel(function (e, delta, deltaX, deltaY) {
                        if (e.ctrlKey) {
                            if (delta > 0) {
                                $(this).css('width', this.width * 1.1);
                            } else {
                                $(this).css('width', this.width / 1.1);
                            }
                            e.preventDefault();
                        }
                    });

                    $(".btn_dom_edit").click(function (e) {
                        var sUrl = this.href, $td = $(this).parent();
                        var formId= "formDominio"+ (new Date()).getTime();

                        $.blockUI({ message: '<h1   > <img src="{{ asset("img/indicator.gif") }}" style="padding-right: 20px;"  /> Procesando...</h1>' });
                        $.ajax({
                            type: "POST",
                            url: sUrl,
                            data: {formId: formId},
                            success: function (data) {
                                $.unblockUI();

                                if (data.length > 0) {
                                    $("<div>" + data + "</div>").dialog({
                                        resizable: false,
                                        title: "Edicion de Automotor",
                                        closeOnEscape: false,
                                        height: 600,
                                        width: 500,
                                        modal: true,
                                        autoOpen: true,
                                        target: '#myModal_auto_edit',
                                        buttons: {
                                            "Guardar": function () {
                                                var dlg = $(this);
                                                $('#'+formId).ajaxSubmit({
                                                    beforeSubmit: showRequest,
                                                    success: function (responseText, statusText, xhr, $form) {
                                                        if (statusText == 'success') {
                                                            $(".dominio_edit", $td).html(responseText);
                                                            alert('Los datos del dominio se han actualizado.');
                                                            dlg.dialog("destroy");
                                                        }


                                                    } });
                                            },
                                            Cerrar: function () {
                                                $(this).dialog("close");
                                            }
                                        }
                                    });
                                }

                            },
                            dataType: 'html'
                        });
                        e.preventDefault();


                    })

                    function showRequest(formData, jqForm, options) {
                        // formData is an array; here we use $.param to convert it to a string to display it
                        // but the form plugin does this for you automatically when it submits the data
                        var queryString = $.param(formData);

                        // jqForm is a jQuery object encapsulating the form element.  To access the
                        // DOM element for the form do this:
                        // var formElement = jqForm[0];

                        //alert('About to submit: \n\n' + queryString);

                        // here we could return false to prevent the form from being submitted;
                        // returning anything other than false will allow the form submit to continue
                        return true;
                    }


                    var menuImg = [
                        {'Cambiar Fotografia': function (menuItem, menu) {
                            var lsForm = "" +
                                    "<form id=\"__form__\" method='post' action='__url__' enctype='multipart/form-data' > " +
                                    "<div class=\"modal-body\">" +
                                    "<h3>Fotografia Nro: <span class='nrofoto'>&nbsp;&nbsp;&nbsp;__foto__</span></h3><br>" +
                                    "<input type=\"hidden\" name=\"nrofoto\" value=\"__foto__\">" +
                                    "<label>Cambiar Fotografia: </label>" +
                                    "<input type=\"file\" id=\"fotoChange\" name=\"foto\"  />" +
                                    "</div>" +
                                    "</form>";
                            formId= "cambiarFotografia"+ (new Date()).getTime();
                            foto = this;
                            sUrl = "{{path("infraccion_cambiar_foto",{id: '__id__' }) }}";
                            id = $(this).data('id');
                            sdir = $(this).data('dir');
                            idFoto = $(this).data('foto');

                            lsForm = lsForm.replace(/__form__/g, formId);
                            lsForm = lsForm.replace(/__url__/g, sUrl);
                            lsForm = lsForm.replace(/__id__/g, id);
                            lsForm = lsForm.replace(/__foto__/g, idFoto);

                            $("<div>" + lsForm + "</div>").dialog({
                                resizable: false,
                                title: "Cambiar de Foto",
                                closeOnEscape: false,
                                height: 280,
                                width: 400,
                                modal: true,
                                autoOpen: true,
                                buttons: {
                                    "Subir": function () {
                                        var dlg = $(this);
                                        $('#'+formId).ajaxSubmit({
                                            beforeSubmit: showRequest,
                                            success: function (responseText, statusText, xhr, $form) {
                                                if (statusText == 'success') {
                                                    //$(foto).attr("src","");

                                                    sfile = "{{ asset(infraccion.infracciones.dir ) }}" + sdir + responseText + "?nocache=" + (new Date()).getTime();
                                                    $(foto).attr("src", sfile);
                                                    dlg.dialog("destroy");
                                                }


                                            } });
                                    },
                                    Cerrar: function () {
                                        $(this).dialog("close");
                                    }
                                }
                            });


//                            $('#cambiarFotografia').modal({
//                                backdrop: true
//                            });
                        } },
//                        $.contextMenu.separator,
//                        {'Option 2': function (menuItem, menu) {
//                            alert("You clicked Option 2!");
//                        } }
                    ];

                    $('.fotoinfra').contextMenu(menuImg, {thme: 'vista'});


                });

            </script>
            {% endblock box_contenido %}
        {% endembed %}


        </section>







    {% endblock %}


    {% block endscript %}
        <script src="{{ asset( 'js/jquery.form.min.js') }}"></script>
        <script src="{{ asset( 'js/jquery.contextmenu.min.js') }}"></script>

    {% endblock endscript %}