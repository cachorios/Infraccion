{% extends '::layout.html.twig' %}
{% block id 'mod_Infraccion' %}

    {% block title %}
        {{ parent() }} - Infracciones
    {% endblock %}

    {% block page %}

        <section id="Infraccion">
            {% form_theme filterForm with ['LexikFormFilterBundle:Form:form_div_layout.html.twig' ] %}

            {% embed 'box.html.twig' with {'box_titulo': 'Lista de Infracciones' } %}
                {% block rigth_title %}
                    <a class="btn dropdown-toggle btn-mini" data-toggle="collapse"
                       data-target="#filters">
                        {{ 'views.index.filters'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                        <span class="caret"></span>
                    </a> &nbsp;
                {% endblock %}

                {% block box_contenido %}

                    <div class="row-fluid">
                        <div class="span12" style="margin-top: 0;">

                            <div class="breadcrumb">
                                <div class="row-fluid">
                                    <div class="span3">
                                        Municipio
                                        <h3> {{ filtro.municipio.nombre }}</h3>
                                    </div>
                                    <div class="span3">Ubicación
                                        <h3> {{ filtro.ubicacion.referencia ~' - '~ filtro.ubicacion.ubicacion }}</h3>
                                    </div>
                                    <div class="span3">
                                        Tipo de Infracción
                                        <h3>{{ filtro.tipoInfraccion.nombre }}</h3>
                                    </div>
                                    <div class="span3">
                                        Fecha
                                        <h2>{{ filtro.fecha |date('d-m-Y') }}</h2>
                                    </div>
                                </div>
                            </div>



                            {% for type, flashMessages in app.session.flashbag.all() %}
                                {% for flashMessage in flashMessages %}
                                    <div class='alert alert-{{ type }}'>
                                        {{ flashMessage|trans({}, 'JordiLlonchCrudGeneratorBundle') }}
                                    </div>
                                {% endfor %}
                            {% endfor %}
                        </div>
                    </div>

                    {% if form_errors(filterForm) %}
                        <div class="alert alert-block alert-error fade in form-errors">
                            {{ form_errors(filterForm) }}
                        </div>
                    {% endif %}
                    &nbsp;

                    <div id="filters" class="collapse">
                        <form class="well" action="{{ path('infraccion') }}"
                              method="post" {{ form_enctype(filterForm) }}>
                            {{ form_row(filterForm.dominio) }}

                            {{ form_row(filterForm.etapa) }}

                            {{ form_rest(filterForm) }}

                            <p>
                                <button type="submit" name="filter_action"
                                        value="reset">{{ 'views.index.reset'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                                <button type="submit" name="filter_action"
                                        value="filter">{{ 'views.index.filter'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</button>
                            </p>
                        </form>
                    </div>

                    <div class="row-fluid" style="margin-top: 0;">
                        <div class="span12" style="zoom: 1; overflow: auto; margin-top: -8px;">
                            <table class="table table-striped table-bordered table-condensed">
                                <thead>
                                <tr>

                                    <th>Dominio</th>
                                    <th>Hora</th>
                                    <th>Datos</th>
                                    <th>Foto 1</th>
                                    {% if filtro.tipoInfraccion.cantidadFoto >= 2 %}
                                        <th>Foto 2</th>
                                    {% endif %}
                                    {% if filtro.tipoInfraccion.cantidadFoto == 3 %}
                                        <th>Foto 3</th>
                                    {% endif %}
                                    <th>Etapa</th>


                                    <th>{{ 'views.index.actions'|trans({}, 'JordiLlonchCrudGeneratorBundle') }}</th>
                                </tr>
                                </thead>
                                <tbody>
                                {% for entity in entities %}
                                    <tr id="{{ entity.id }}">
                                        {% include 'InfraccionBundle:Infraccion:_tr.html.twig' with {entity: entity} %}
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="row-fluid">

                        <div class="span10">
                            {{ pagerHtml|raw }}
                        </div>

                        {#<div class="span2">#}
                        {#<a class="btn btn-primary likepaginator" href="{{ path('infraccion_new') }}">#}
                        {#{{ 'views.index.createnew'|trans({}, 'JordiLlonchCrudGeneratorBundle') }} Infraccion#}
                        {#</a>#}
                        {#</div>#}
                    </div>


                    {#para modal#}
                    <div id="myModal_auto_edit"
                    </div>

                {% endblock box_contenido %}
            {% endembed %}


        </section>

        <script>

        $(function () {

            $("#Infraccion").delegate(".fotoinfra", 'dblclick', function () {
                $(this).css('width', 200);
            });


            $("#Infraccion").delegate(".fotoinfra", "mousewheel", function (e, delta, deltaX, deltaY) {
                if (e.ctrlKey) {
                    if (delta > 0) {
                        $(this).css('width', this.width * 1.1);
                    } else {
                        $(this).css('width', this.width / 1.1);
                    }
                    e.preventDefault();
                }
            });

            $("#Infraccion").delegate(".btn_dom_edit", "click", function (e) {
                var sUrl = this.href, $td = $(this).parent();
                var formId = "formDominio" + (new Date()).getTime();

                $.blockUI({ message: '<h1   > <img src="{{ asset("img/indicator.gif") }}" style="padding-right: 20px;"  /> Procesando...</h1>' });
                $.ajax({
                    type: "POST",
                    url: sUrl,
                    data: {formId: formId},
                    success: function (data) {
                        $.unblockUI();

                        if (data.length > 0) {
                            $("<div>" + data + "</div>").dialog({
                                resizable: false,
                                title: "Edicion de Automotor",
                                closeOnEscape: false,
                                height: 600,
                                width: 500,
                                modal: true,
                                autoOpen: true,
                                target: '#myModal_auto_edit',
                                buttons: {
                                    "Guardar": function () {
                                        var dlg = $(this);
                                        $('#' + formId).ajaxSubmit({
                                            beforeSubmit: showRequest,
                                            success: function (responseText, statusText, xhr, $form) {
                                                if (statusText == 'success') {
                                                    $(".dominio_edit", $td).html(responseText);
                                                    alert('Los datos del dominio se han actualizado.');
                                                    dlg.dialog("destroy");
                                                }


                                            } });
                                    },
                                    Cerrar: function () {
                                        $(this).dialog("close");
                                    }
                                }
                            });
                        }

                    },
                    dataType: 'html'
                });
                e.preventDefault();


            })

            $("#Infraccion").delegate(".edit_infraccion", "click", function (e) {
                var sUrl = this.href, idForm = "formInfraccion" + (new Date()).getTime();

                e.preventDefault();

                $.blockUI({ message: '<h1   > <img src="{{ asset("img/indicator.gif") }}" style="padding-right: 20px;"  /> Procesando...</h1>' });
                $.ajax({
                    type: "POST",
                    url: sUrl,
                    data: {idForm: idForm},
                    dataType: 'html',
                    success: function (ret) {
                        $.unblockUI();
                        dialogo(
                                "Infraccion",
                                ret,
                                {
                                    Guardar: function () {
                                        var dlg = this, formName = "#" + idForm;
                                        //var a = $("#formInfraccion");
                                        $(formName).ajaxSubmit({
                                            dataType: 'json',
                                            success: function (responseText, statusText, xhr, $form) {
                                                if (statusText == 'success') {
                                                    if (responseText.ok == 1) {

                                                        $("#" + responseText.id).html(responseText.html)
                                                        $('.fotoinfra').contextMenu(menuImg, {thme: 'vista'});
                                                        $(dlg).dialog("close");
                                                    }
                                                }
                                            },
                                            error: function (responseText, statusText, xhr, $form) {
                                                var html = $(responseText.responseText), contenido;
                                                $(formName).html(html.html());
                                            }
                                        });
                                    },
                                    Cerrar: closeDlg },
                                500,
                                480);
                    }
                });

                return false;
            });

            var menuImg = [
                {'Cambiar Fotografia': function (menuItem, menu) {
                    var lsForm = "" +
                            "<form id=\"__form__\" method='post' action='__url__' enctype='multipart/form-data' > " +
                            "<div class=\"modal-body\">" +
                            "<h3>Fotografia Nro: <span class='nrofoto'>&nbsp;&nbsp;&nbsp;__foto__</span></h3><br>" +
                            "<input type=\"hidden\" name=\"nrofoto\" value=\"__foto__\">" +
                            "<label>Cambiar Fotografia: </label>" +
                            "<input type=\"file\" id=\"fotoChange\" name=\"foto\"  />" +
                            "</div>" +
                            "</form>";
                    formId = "cambiarFotografia" + (new Date()).getTime();
                    foto = this;
                    sUrl = "{{path("infraccion_cambiar_foto",{id: '__id__' }) }}";
                    id = $(this).data('id');
                    sdir = $(this).data('dir');
                    idFoto = $(this).data('foto');

                    lsForm = lsForm.replace(/__form__/g, formId);
                    lsForm = lsForm.replace(/__url__/g, sUrl);
                    lsForm = lsForm.replace(/__id__/g, id);
                    lsForm = lsForm.replace(/__foto__/g, idFoto);

                    $("<div>" + lsForm + "</div>").dialog({
                        resizable: false,
                        title: "Cambiar de Foto",
                        closeOnEscape: false,
                        height: 280,
                        width: 400,
                        modal: true,
                        autoOpen: true,
                        buttons: {
                            "Subir": function () {
                                var dlg = $(this);
                                $('#' + formId).ajaxSubmit({
                                    beforeSubmit: showRequest,
                                    success: function (responseText, statusText, xhr, $form) {
                                        if (statusText == 'success') {
                                            //$(foto).attr("src","");

                                            sfile = "{{ asset(infraccion.infracciones.dir ) }}" + sdir + responseText + "?nocache=" + (new Date()).getTime();
                                            $(foto).attr("src", sfile);
                                            dlg.dialog("destroy");
                                        }


                                    } });
                            },
                            Cerrar: function () {
                                $(this).dialog("close");
                            }
                        }
                    });

                } } //,
//                        $.contextMenu.separator,
//                        {'Option 2': function (menuItem, menu) {
//                            alert("You clicked Option 2!");
//                        } }
            ];
            $('.fotoinfra').contextMenu(menuImg, {thme: 'vista'});


        }) ;

        dialogo = function (title, content, aButtons, nW, nH) {

            nW = nW == null ? 400 : nW;
            nH = nH == null ? 280 : nH;

            if (aButtons == null) {
                aButtons = {"Cerrar": closeDlg };
            }


            $("<div>" + content + "</div>").dialog({
                resizable: false,
                draggable: true,
                title: title,
                closeOnEscape: false,
                height: nH,
                width: nW,
                modal: true,
                autoOpen: true,
                show: {
                    effect: "blind",
                    duration: 500
                },
                hide: {
                    effect: "blind",
                    duration: 500
                },
                buttons: aButtons
            });
        };

        closeDlg = function () {
            $(this).dialog("close");
        }

        function showRequest(formData, jqForm, options) {

            var queryString = $.param(formData);


            return true;
        }


        </script>

    {% endblock %}


    {% block endscript %}
        <script src="{{ asset( 'js/jquery.form.min.js') }}"></script>
        <script src="{{ asset( 'js/jquery.contextmenu.min.js') }}"></script>

    {% endblock endscript %}